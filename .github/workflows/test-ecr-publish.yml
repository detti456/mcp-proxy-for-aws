name: Test ECR Publish

on:
  push:
    branches:
      - test-publish-container-image

permissions: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.get-package-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up uv
        uses: astral-sh/setup-uv@v4

      - name: Build distribution packages
        run: uv build

      - name: Upload distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Get version from package
        id: get-package-version
        run: |
          set -euo pipefail

          # Get version from uv
          VERSION="$(uv tree 2>/dev/null | grep mcp-proxy-for-aws | sed -e 's/^.*[[:space:]]v\(.*\)/\1/g' | head -1)"

          if [[ -z "$VERSION" ]]; then
            echo "::error::Failed to extract version from package" >&2
            exit 1
          fi

          # Validate version format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION" >&2
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "::debug::Package version: $VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Build Docker image
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6.16.0
        with:
          platforms: 'linux/amd64,linux/arm64'
          context: .
          file: ./Dockerfile
          push: false
          tags: mcp-proxy-for-aws:${{ steps.get-package-version.outputs.version }}
          outputs: type=oci,dest=/tmp/mcp-proxy-for-aws-${{ steps.get-package-version.outputs.version }}.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Load Docker image
        run: docker load --input /tmp/mcp-proxy-for-aws-${{ steps.get-package-version.outputs.version }}.tar

      - name: Generate CycloneDX SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: mcp-proxy-for-aws:${{ steps.get-package-version.outputs.version }}
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json

      - name: Install CycloneDX CLI
        run: |
          wget -q https://github.com/CycloneDX/cyclonedx-cli/releases/latest/download/cyclonedx-linux-x64 -O cyclonedx
          chmod +x cyclonedx
          sudo mv cyclonedx /usr/local/bin/

      - name: Convert SBOM to CSV
        run: |
          cyclonedx convert --input-file sbom.cyclonedx.json --input-format json --output-format csv --output-file SBOM-${{ steps.get-package-version.outputs.version }}.csv

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.get-package-version.outputs.version }}
          path: SBOM-${{ steps.get-package-version.outputs.version }}.csv
          retention-days: 90

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ steps.get-package-version.outputs.version }}
          path: /tmp/mcp-proxy-for-aws-${{ steps.get-package-version.outputs.version }}.tar
          retention-days: 1

  test-container-build:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ needs.build.outputs.version }}
          path: /tmp/

      - name: Load Docker image
        run: docker load --input /tmp/mcp-proxy-for-aws-${{ needs.build.outputs.version }}.tar

      - name: Publish Container to Private ECR
        id: publish-container
        uses: ./.github/actions/build-and-push-container-image-test
        with:
          image: mcp-proxy-for-aws-test
          version: ${{ needs.build.outputs.version }}
          ecr-role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          ecr-repository: mcp-proxy-for-aws-test
          ecr-aws-region: eu-north-1
